;; --- Package Initialization ---
(require 'package)
(setq package-archives
      '(("melpa" . "https://melpa.org/packages/")
        ("gnu"   . "https://elpa.gnu.org/packages/")))
(unless (bound-and-true-p package--initialized)
  (package-initialize))
(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))
(eval-when-compile (require 'use-package))
(require 'bind-key)
(setq use-package-always-ensure t)

;; --- TRAMP Optimization ---
(setq tramp-default-method "ssh")
(setq tramp-ssh-controlmaster-options
      "-o ControlMaster=auto -o ControlPersist=yes -o ControlPath='~/.ssh/control-%%r@%%h:%%p'")
(setq tramp-copy-size-limit 1000000)
(setq tramp-verbose 1
      create-lockfiles nil
      tramp-auto-save-directory "~/.emacs.d/tramp-autosave")
(setq vc-ignore-dir-regexp
      (format "\\(%s\\)\\|\\(%s\\)"
              vc-ignore-dir-regexp
              tramp-file-name-regexp))

;; --- Line Truncation ---
(set-default 'truncate-lines t)

;; --- Auto-mode Settings ---
(add-to-list 'auto-mode-alist '(".*/bash/rc\\'" . sh-mode))
(add-to-list 'auto-mode-alist '(".*/bash/profile\\'" . sh-mode))
(add-to-list 'auto-mode-alist '(".*\\.tex\\.mustache\\'" . latex-mode))
(add-to-list 'auto-mode-alist '(".*\\.tex\\.jinja2\\'" . latex-mode))
(add-to-list 'auto-mode-alist '("\\.py\\'" . python-mode))

;; --- Python Mode ---
(use-package python-mode
  :hook (python-mode . (lambda ()
                         (setq python-indent-offset 4
                               tab-width 4
                               indent-tabs-mode nil))))

;; --- Pyenv ---
(use-package pyenv-mode
  :config (setenv "WORKON_HOME" "~/.virtualenvs")
  :hook (python-mode . pyenv-mode))

;; --- LSP Mode (disabled on remote) ---
(use-package lsp-mode
  :hook (python-mode . (lambda ()
                         (unless (file-remote-p (or buffer-file-name default-directory))
                           (lsp-deferred))))
  :custom
  (lsp-enable-file-watchers nil)
  (lsp-file-watch-threshold 10000)
  (lsp-pyright-multi-root nil)
  (lsp-enable-snippet nil)
  (lsp-pyright-venv-path "~/.virtualenvs")
  (lsp-pyright-python-executable-cmd "python"))

(use-package lsp-pyright
  :after lsp-mode
  :hook (python-mode . (lambda ()
                         (unless (file-remote-p (or buffer-file-name default-directory))
                           (require 'lsp-pyright)
                           (lsp)))))

;; --- Company Mode ---
(use-package company
  :hook (prog-mode . company-mode)
  :custom
  (company-idle-delay 0.2)
  (company-minimum-prefix-length 2)
  (company-tooltip-align-annotations t)
  (company-selection-wrap-around t)
  (company-show-numbers t)
  :bind (:map company-active-map
              ("<tab>" . company-complete-selection)
              ("C-n"   . company-select-next)
              ("C-p"   . company-select-previous)))

;; --- Flycheck ---
(use-package flycheck
  :hook (python-mode . flycheck-mode))

;; --- Black + isort (disabled on remote) ---
(defun my/python-before-save-local ()
  (unless (file-remote-p (or buffer-file-name default-directory))
    (when (boundp 'blacken-mode) (blacken-buffer))
    (when (boundp 'isortify-mode) (isortify-buffer))))

(use-package blacken
  :hook (python-mode . blacken-mode))

(use-package isortify
  :hook (python-mode . isortify-mode))

(add-hook 'python-mode-hook
          (lambda ()
            (add-hook 'before-save-hook #'my/python-before-save-local nil t)))

;; --- Appearance ---
(global-display-line-numbers-mode t)
(setq dired-listing-switches "-1")

;; --- ANSI Colors ---
(use-package ansi-color
  :config
  (defun colorize-compilation-buffer ()
    (ansi-color-apply-on-region compilation-filter-start (point-max)))
  (add-hook 'compilation-filter-hook 'colorize-compilation-buffer)
  (defun my-shell-mode-hook () (ansi-color-for-comint-mode-on))
  (add-hook 'shell-mode-hook 'my-shell-mode-hook))

;; --- LaTeX ---
(use-package tex
  :ensure auctex
  :hook (latex-mode . (lambda () (setq TeX-PDF-mode t))))

;; --- Magit ---
(use-package magit
  :commands magit-status
  :config
  (global-set-key (kbd "C-x g") 'magit-status))

;; --- Which-key ---
(use-package which-key
  :config (which-key-mode))
